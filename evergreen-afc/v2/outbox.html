<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sent Faxes - Evergreen AFC</title>
    <script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --success: #43a047;
            --warning: #ff9800;
            --error: #e53935;
            --text: #333;
            --text-light: #666;
            --border: #e0e0e0;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; }
        body { padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%); min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Header */
        .header-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-top: 4px solid var(--primary); }
        .header-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { height: 48px; width: auto; border-radius: 8px; }
        .brand-info h2 { color: var(--primary-dark); font-size: 18px; font-weight: 700; }
        .brand-info span { color: var(--text-light); font-size: 13px; }
        h1 { margin: 20px 0 0 0; color: var(--primary-dark); font-size: 28px; display: flex; align-items: center; gap: 12px; font-weight: 700; }
        
        /* Stats */
        .stats-bar { display: flex; gap: 20px; margin-top: 16px; flex-wrap: wrap; }
        .stat-item { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #f5f5f5; border-radius: 8px; font-size: 14px; }
        .stat-value { font-weight: 700; color: var(--primary); }
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.error { color: var(--error); }
        
        /* Buttons */
        .btn { padding: 10px 20px; background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(46,125,50,0.3); }
        .btn-secondary { background: #f5f5f5; color: var(--text); }
        .btn-secondary:hover { background: #e0e0e0; box-shadow: none; transform: none; }
        
        /* Search & Filter */
        .search-bar { display: flex; gap: 12px; margin: 16px 0; flex-wrap: wrap; align-items: center; }
        .search-input { flex: 1; min-width: 200px; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1); }
        .filter-select { padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: white; cursor: pointer; }
        .filter-select:focus { outline: none; border-color: var(--primary); }
        
        /* Fax List */
        .fax-list { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .fax-item { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f0f0f0; transition: all 0.2s; }
        .fax-item:hover { background: #f5f5f5; }
        .fax-item:last-child { border-bottom: none; }
        .fax-icon { font-size: 28px; margin-right: 16px; }
        .fax-details { flex: 1; min-width: 0; }
        .fax-to { font-weight: 600; color: var(--primary-dark); font-size: 15px; }
        .fax-date { color: var(--text-light); font-size: 13px; margin-top: 4px; }
        .fax-pages { color: var(--text-light); font-size: 13px; padding: 4px 12px; background: #f5f5f5; border-radius: 12px; margin-right: 12px; white-space: nowrap; }
        .fax-status { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .fax-status.sent { background: #e8f5e9; color: var(--success); }
        .fax-status.pending { background: #fff8e1; color: var(--warning); }
        .fax-status.failed { background: #ffebee; color: var(--error); }
        .fax-error { font-size: 12px; color: var(--error); margin-top: 4px; font-style: italic; }
        .retry-btn { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%) !important; }
        .retry-btn:hover { box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4); }
        .fax-actions { display: flex; gap: 8px; margin-left: 12px; }
        .action-btn { padding: 8px 14px; background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .action-btn:hover { transform: translateY(-1px); }
        .action-btn.secondary { background: #f5f5f5; color: var(--text); }
        .action-btn.secondary:hover { background: #e0e0e0; }
        
        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
        .page-btn { padding: 8px 14px; background: white; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .page-btn:hover { border-color: var(--primary); }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .per-page-select { padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
        .empty-icon { font-size: 64px; margin-bottom: 16px; }
        
        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-light); }
        .spinner { width: 40px; height: 40px; border: 4px solid #f0f0f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* PDF Viewer Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 900px; height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: var(--primary); color: white; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0 8px; }
        .modal-close:hover { opacity: 0.8; }
        .modal-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .pdf-frame { flex: 1; border: none; width: 100%; }
        .modal-actions { padding: 16px 20px; background: #f5f5f5; display: flex; justify-content: flex-end; gap: 12px; }
        .modal-loading { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-light); }
        
        /* Tech Support */
        .support-link { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 12px 20px; border-radius: 50px; text-decoration: none; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 20px rgba(46, 125, 50, 0.4); transition: all 0.2s; z-index: 100; }
        .support-link:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(46, 125, 50, 0.5); }
        
        /* Footer */
        .powered-by { text-align: center; margin-top: 24px; font-size: 12px; color: var(--text-light); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .powered-by a { color: var(--primary); text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .lnt-logo { height: 20px; width: auto; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .fax-item { flex-direction: column; align-items: flex-start; gap: 12px; }
            .fax-actions { width: 100%; justify-content: flex-end; }
            .modal-content { height: 100vh; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div class="header-top">
                <div class="brand">
                    <img src="https://logicnetworkstech.github.io/MSP-client-apps/evergreen-afc/v2/assets/evergreen-logo.jpg" alt="Evergreen AFC" class="logo" onerror="this.style.display='none'">
                    <div class="brand-info">
                        <h2>Evergreen AFC</h2>
                        <span>eFax Portal</span>
                    </div>
                </div>
                <div>
                    <button class="btn" onclick="refreshOutbox()">Refresh</button>
                    <button class="btn btn-secondary" onclick="exportToCSV()">Export CSV</button>
                </div>
            </div>
            <h1>üì§ Sent Faxes</h1>
            <div class="stats-bar">
                <div class="stat-item">Total: <span class="stat-value" id="totalCount">0</span></div>
                <div class="stat-item">Delivered: <span class="stat-value success" id="deliveredCount">0</span></div>
                <div class="stat-item">Pending: <span class="stat-value warning" id="pendingCount">0</span></div>
                <div class="stat-item">Failed: <span class="stat-value error" id="failedCount">0</span></div>
            </div>
        </div>
        
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="Search by recipient fax number..." oninput="filterFaxes()">
            <select class="filter-select" id="dateFilter" onchange="filterFaxes()">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
            <select class="filter-select" id="statusFilter" onchange="filterFaxes()">
                <option value="all">All Status</option>
                <option value="sent">Delivered</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
            </select>
        </div>
        
        <div class="fax-list" id="faxList">
            <div class="loading"><div class="spinner"></div> Loading sent faxes...</div>
        </div>
        
        <div class="pagination" id="pagination"></div>
        
        <div class="powered-by">
            Powered by <a href="https://logicnetworks.us" target="_blank">
                <img src="https://logicnetworkstech.github.io/MSP-client-apps/evergreen-afc/v2/assets/lnt-gear.png" alt="LNT" class="lnt-logo" onerror="this.style.display='none'">
                Logic Networks
            </a>
        </div>
    </div>
    
    <!-- PDF Viewer Modal -->
    <div class="modal-overlay" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Fax Preview</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="modal-loading"><div class="spinner"></div> Loading fax...</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn" id="downloadBtn" onclick="downloadCurrentFax()">Download PDF</button>
            </div>
        </div>
    </div>
    
    <!-- Tech Support Link -->
    <a href="mailto:support@logicnetworks.us?subject=eFax Support Request - Evergreen AFC" class="support-link">Tech Support</a>

    <script>
        microsoftTeams.app.initialize();

        const CONFIG = {
            proxyUrl: 'https://srfax-proxy.nbalbi.workers.dev',
            clientId: 'EVERGREEN'
        };

        let allFaxes = [];
        let filteredFaxes = [];
        let currentPage = 1;
        let perPage = 10;
        let currentPdfData = null;
        let currentFileName = null;

        document.addEventListener('DOMContentLoaded', loadOutbox);

        async function loadOutbox() {
            try {
                const formData = new FormData();
                formData.append('action', 'Get_Fax_Outbox');
                formData.append('sPeriod', 'ALL');
                formData.append('sIncludeSubUsers', 'Y');

                const response = await fetch(CONFIG.proxyUrl, {
                    method: 'POST',
                    headers: { 'X-Client-ID': CONFIG.clientId },
                    body: formData
                });

                const data = await response.json();

                if (data.Status === 'Success' && Array.isArray(data.Result)) {
                    allFaxes = data.Result;
                    filterFaxes();
                    updateStats();
                } else {
                    document.getElementById('faxList').innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No sent faxes found</p></div>';
                }
            } catch (error) {
                document.getElementById('faxList').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading faxes: ' + error.message + '</p></div>';
            }
        }

        function refreshOutbox() {
            document.getElementById('faxList').innerHTML = '<div class="loading"><div class="spinner"></div> Refreshing...</div>';
            loadOutbox();
        }

        function updateStats() {
            const delivered = allFaxes.filter(f => f.SentStatus === 'Sent').length;
            const pending = allFaxes.filter(f => !['Sent', 'Failed'].includes(f.SentStatus)).length;
            const failed = allFaxes.filter(f => f.SentStatus === 'Failed').length;

            document.getElementById('totalCount').textContent = allFaxes.length;
            document.getElementById('deliveredCount').textContent = delivered;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('failedCount').textContent = failed;
        }

        function filterFaxes() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredFaxes = allFaxes.filter(fax => {
                const toNum = fax.ToFaxNumber || fax.DestinationFaxNumber || '';
                const matchSearch = !search || toNum.toLowerCase().includes(search);

                let matchDate = true;
                if (dateFilter !== 'all' && fax.Date) {
                    const faxDate = new Date(fax.Date);
                    const today = new Date();
                    if (dateFilter === 'today') matchDate = faxDate.toDateString() === today.toDateString();
                    else if (dateFilter === 'week') {
                        const weekAgo = new Date(today.setDate(today.getDate() - 7));
                        matchDate = faxDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date(today.setMonth(today.getMonth() - 1));
                        matchDate = faxDate >= monthAgo;
                    }
                }

                let matchStatus = true;
                if (statusFilter === 'sent') matchStatus = fax.SentStatus === 'Sent';
                else if (statusFilter === 'pending') matchStatus = !['Sent', 'Failed'].includes(fax.SentStatus);
                else if (statusFilter === 'failed') matchStatus = fax.SentStatus === 'Failed';

                return matchSearch && matchDate && matchStatus;
            });

            currentPage = 1;
            renderFaxes();
        }

        function renderFaxes() {
            const container = document.getElementById('faxList');
            const start = (currentPage - 1) * perPage;
            const pageFaxes = filteredFaxes.slice(start, start + perPage);

            if (pageFaxes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No faxes match your criteria</p></div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            container.innerHTML = pageFaxes.map(fax => {
                const toNum = fax.ToFaxNumber || fax.DestinationFaxNumber || 'Unknown';
                const status = fax.SentStatus || 'Pending';
                const statusClass = status === 'Sent' ? 'sent' : status === 'Failed' ? 'failed' : 'pending';
                const statusText = status === 'Sent' ? 'Delivered' : status;
                
                // Get failure reason if available
                const errorReason = getErrorReason(fax);
                const showRetry = status === 'Failed';

                return `
                    <div class="fax-item">
                        <span class="fax-icon">${status === 'Failed' ? '‚ùå' : status === 'Sent' ? '‚úÖ' : '‚è≥'}</span>
                        <div class="fax-details">
                            <div class="fax-to">To: ${formatPhone(toNum)}</div>
                            <div class="fax-date">${fax.Date || 'Unknown date'} ${fax.EpochTime ? '‚Ä¢ ' + new Date(fax.EpochTime * 1000).toLocaleTimeString() : ''}</div>
                            ${errorReason ? `<div class="fax-error">‚ö†Ô∏è ${errorReason}</div>` : ''}
                        </div>
                        <span class="fax-pages">${fax.Pages || '?'} pages</span>
                        <span class="fax-status ${statusClass}">${statusText}</span>
                        <div class="fax-actions">
                            ${showRetry ? `<button class="action-btn retry-btn" onclick="retryFax('${fax.FileName}', '${toNum}')">üîÑ Retry</button>` : ''}
                            <button class="action-btn" onclick="downloadFax('${fax.FileName}')">Download</button>
                            <button class="action-btn secondary" onclick="previewFax('${fax.FileName}', '${formatPhone(toNum)}')">Preview</button>
                        </div>
                    </div>
                `;
            }).join('');

            renderPagination();
        }
        
        function getErrorReason(fax) {
            // SRFax error codes/reasons
            const errorMap = {
                'No Answer': 'Recipient fax machine did not answer',
                'Busy': 'Recipient fax line was busy',
                'No Dial Tone': 'Could not get dial tone',
                'Invalid Number': 'The fax number is invalid or disconnected',
                'Call Failed': 'Call could not be completed',
                'Line Quality': 'Poor line quality during transmission',
                'Cancelled': 'Fax was cancelled',
                'Failed': 'Transmission failed'
            };
            
            if (fax.SentStatus !== 'Failed') return null;
            
            // Check various fields where error might be stored
            const errorText = fax.ErrorCode || fax.ResultCode || fax.ErrorMessage || fax.Result || '';
            
            // Try to match known errors
            for (const [key, desc] of Object.entries(errorMap)) {
                if (errorText.toLowerCase().includes(key.toLowerCase())) {
                    return desc;
                }
            }
            
            // Return raw error if available, or generic message
            if (errorText && errorText !== 'Failed') return errorText;
            return 'Transmission failed - check recipient number';
        }
        
        async function retryFax(fileName, toNumber) {
            if (!confirm(`Retry sending fax to ${formatPhone(toNumber)}?`)) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Retrying...';
            
            try {
                // First, retrieve the original fax content
                const formData = new FormData();
                formData.append('action', 'Retrieve_Fax');
                formData.append('sFaxFileName', fileName);
                formData.append('sDirection', 'OUT');
                formData.append('sFaxFormat', 'PDF');

                const response = await fetch(CONFIG.proxyUrl, {
                    method: 'POST',
                    headers: { 'X-Client-ID': CONFIG.clientId },
                    body: formData
                });

                const data = await response.json();

                if (data.Status === 'Success' && data.Result) {
                    // Now queue a new fax with the same content
                    const sendForm = new FormData();
                    sendForm.append('action', 'Queue_Fax');
                    sendForm.append('sSenderEmail', 'fax@evergreenafcma.com');
                    sendForm.append('sFaxType', 'SINGLE');
                    sendForm.append('sToFaxNumber', toNumber.replace(/\D/g, ''));
                    sendForm.append('sFileName_1', 'retry_' + fileName);
                    sendForm.append('sFileContent_1', data.Result);
                    
                    const sendResponse = await fetch(CONFIG.proxyUrl, {
                        method: 'POST',
                        headers: { 'X-Client-ID': CONFIG.clientId },
                        body: sendForm
                    });
                    
                    const sendData = await sendResponse.json();
                    
                    if (sendData.Status === 'Success') {
                        alert('Fax queued for retry! Check back in a few minutes.');
                        loadOutbox(); // Refresh
                    } else {
                        throw new Error(sendData.Result || 'Failed to queue retry');
                    }
                } else {
                    throw new Error('Could not retrieve original fax');
                }
            } catch (error) {
                alert('Retry failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Retry';
            }
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredFaxes.length / perPage);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += '<span>...</span>';
                }
            }

            html += `
                <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                <select class="per-page-select" onchange="changePerPage(this.value)">
                    <option value="10" ${perPage === 10 ? 'selected' : ''}>10/page</option>
                    <option value="25" ${perPage === 25 ? 'selected' : ''}>25/page</option>
                    <option value="50" ${perPage === 50 ? 'selected' : ''}>50/page</option>
                </select>
            `;

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredFaxes.length / perPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderFaxes();
        }

        function changePerPage(value) {
            perPage = parseInt(value);
            currentPage = 1;
            renderFaxes();
        }

        function formatPhone(num) {
            if (!num) return '';
            const cleaned = ('' + num).replace(/\D/g, '');
            const match = cleaned.match(/^(\d{1})?(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return match[1] ? `+${match[1]} (${match[2]}) ${match[3]}-${match[4]}` : `(${match[2]}) ${match[3]}-${match[4]}`;
            }
            return num;
        }

        async function downloadFax(fileName) {
            try {
                const btn = event.target;
                btn.textContent = 'Loading...';
                btn.disabled = true;

                const formData = new FormData();
                formData.append('action', 'Retrieve_Fax');
                formData.append('sFaxFileName', fileName);
                formData.append('sDirection', 'OUT');
                formData.append('sFaxFormat', 'PDF');

                const response = await fetch(CONFIG.proxyUrl, {
                    method: 'POST',
                    headers: { 'X-Client-ID': CONFIG.clientId },
                    body: formData
                });

                const data = await response.json();

                if (data.Status === 'Success' && data.Result) {
                    const link = document.createElement('a');
                    link.href = 'data:application/pdf;base64,' + data.Result;
                    link.download = fileName.replace(/\.[^/.]+$/, '') + '.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    throw new Error(data.Result || 'Failed to download fax');
                }
            } catch (error) {
                alert('Download error: ' + error.message);
            } finally {
                const btn = event.target;
                btn.textContent = 'Download';
                btn.disabled = false;
            }
        }

        async function previewFax(fileName, recipientInfo) {
            currentFileName = fileName;
            document.getElementById('modalTitle').textContent = 'Fax to ' + (recipientInfo || 'Unknown');
            document.getElementById('modalBody').innerHTML = '<div class="modal-loading"><div class="spinner"></div> Loading fax...</div>';
            document.getElementById('pdfModal').classList.add('visible');

            try {
                const formData = new FormData();
                formData.append('action', 'Retrieve_Fax');
                formData.append('sFaxFileName', fileName);
                formData.append('sDirection', 'OUT');
                formData.append('sFaxFormat', 'PDF');

                const response = await fetch(CONFIG.proxyUrl, {
                    method: 'POST',
                    headers: { 'X-Client-ID': CONFIG.clientId },
                    body: formData
                });

                const data = await response.json();

                if (data.Status === 'Success' && data.Result) {
                    currentPdfData = data.Result;
                    
                    // Use data URL instead of blob URL for better compatibility
                    const dataUrl = 'data:application/pdf;base64,' + data.Result;
                    
                    document.getElementById('modalBody').innerHTML = `
                        <iframe class="pdf-frame" src="${dataUrl}#toolbar=1&navpanes=0"></iframe>
                    `;
                } else {
                    throw new Error(data.Result || 'Failed to load fax');
                }
            } catch (error) {
                document.getElementById('modalBody').innerHTML = `
                    <div class="modal-loading">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                            <p style="margin-bottom: 16px;">Could not preview fax: ${error.message}</p>
                            <button class="btn" onclick="downloadCurrentFax()">Download PDF Instead</button>
                        </div>
                    </div>
                `;
            }
        }

        function closeModal() {
            document.getElementById('pdfModal').classList.remove('visible');
            currentPdfData = null;
            currentFileName = null;
        }

        function downloadCurrentFax() {
            if (currentPdfData && currentFileName) {
                const link = document.createElement('a');
                link.href = 'data:application/pdf;base64,' + currentPdfData;
                link.download = currentFileName.replace(/\.[^/.]+$/, '') + '.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function exportToCSV() {
            if (filteredFaxes.length === 0) { alert('No faxes to export'); return; }

            const headers = ['Date', 'To', 'Pages', 'Status'];
            const rows = filteredFaxes.map(f => [
                f.Date || '',
                f.ToFaxNumber || f.DestinationFaxNumber || '',
                f.Pages || '',
                f.SentStatus || 'Pending'
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = 'fax-outbox-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
